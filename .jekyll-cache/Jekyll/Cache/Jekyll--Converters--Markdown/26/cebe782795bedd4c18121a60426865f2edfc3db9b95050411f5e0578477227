I"h!<p>In Part 1, we setup a Django server using uWSGI/Gunicorn and Nginx. This server only contain one service which is our application server. But sometimes, our server can have more than one service e.g. Celery Worker and Celery Beat etc. These services can be run using Supervisor.</p>

<!--more-->

<h1 id="what-is-celery">What is Celery</h1>

<p>Celery is a simple, flexible, and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system. Itâ€™s a task queue with focus on real-time processing, while also supporting task scheduling. Celery communicates via messages, usually using a broker to mediate between clients and workers. To initiate a task the client adds a message to the queue, the broker then delivers that message to a worker. Celery supports several message transport alternatives. List of supported brokers can be found <a href="http://docs.celeryproject.org/en/latest/getting-started/brokers/index.html">here</a>.</p>

<h1 id="setup">Setup</h1>

<p>To setup Celery for your project, you first need to choose a broker. For our current setup, we will be using Redis. For this, you first need to install Redis on your machine by running below command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>redis
</code></pre></div></div>

<p>Install Celery in your virtual environment by running below command and update your requirements.txt file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>celery[redis]
pip freeze <span class="o">&gt;</span> requirements.txt
</code></pre></div></div>

<p>In next step, add a file <code class="highlighter-rouge">celery.py</code> in your project directory (with <code class="highlighter-rouge">settings.py</code> file). This file will look like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># set the default Django settings module for the 'celery' program.
</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'myproject.settings'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'myproject'</span><span class="p">)</span>

<span class="c1"># Using a string here means the worker doesn't have to serialize
# the configuration object to child processes.
# - namespace='CELERY' means all celery-related configuration keys
#   should have a `CELERY_` prefix.
</span><span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'CELERY'</span><span class="p">)</span>

<span class="c1"># Load task modules from all registered Django app configs.
</span><span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>
</code></pre></div></div>

<p>You can create your tasks like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
</code></pre></div></div>
<p>You will have to run your Worker process like this.</p>

<blockquote>
  <p>$ celery -A myproject worker -l info</p>
</blockquote>

<p>A task can be added in queue using <code class="highlighter-rouge">delay</code> function like shown below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="celery-beat">Celery Beat</h1>
<p>Celery Beat is a task scheduler which run a task periodically according to settings provided. Tasks are executed by available Worker nodes in the cluster. To add a periodic tasks for your project, just add following lines in your <code class="highlighter-rouge">celery.py</code> file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>

<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">beat_schedule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'your_task_id'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'task'</span><span class="p">:</span> <span class="s">'your_task'</span><span class="p">,</span>
        <span class="n">schedule</span><span class="s">': crontab(hour='</span><span class="o">*</span><span class="s">', minute='</span><span class="o">*/</span><span class="mi">30</span><span class="s">')</span><span class="err">
</span><span class="s">    },</span><span class="err">
</span><span class="s">}</span><span class="err">
</span></code></pre></div></div>
<p>Run Celery Beat service like This</p>

<blockquote>
  <p>$ celery -A myproject beat</p>
</blockquote>

<p>Above setting will run your task after every 30 minutes. Further settings can be seen <a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html">here</a>.</p>

<h1 id="deployment">Deployment</h1>

<p>For the deployment, supervisor can be used to run Celery Worker and Beat services. Django app will be run in similar way as discussed in Part 1. We will be making similar supervisor configurations for Celery Worker and Beat.</p>

<h2 id="for-celery-worker">For Celery Worker</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[program:celery_worker]
numprocs=1
command=celery -A myproject worker -l info
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600
stopsignal=QUIT
stopasgroup=true
killasgroup=true
priority=1000
</code></pre></div></div>

<h2 id="for-celery-beat">For Celery Beat</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[program:celery_beat]
numprocs=1
command=celery -A myproject worker -l info
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600
stopsignal=QUIT
stopasgroup=true
killasgroup=true
priority=1001
</code></pre></div></div>

<p>One important thing is the priority of the your supervisor services. The priority of Celery Worker will be higher that Celery Beat.</p>

<h1 id="deploy-new-version">Deploy New Version</h1>

<p>When you will add a new task or make some changes in existing tasks, you will have to restart both services. You will do this by running below commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>supervisorctl restart celery_worker
<span class="nb">sudo </span>supervisorctl restart celery_beat
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>

<p>In this article, we added setup Celery Worker and Beat in Django app that we setup in Part 1. We used Redis server as broker for our Celery setup. Then we ran Celery Worker and Beat services using supervisor. In next article, we will discuss how we can automate this whole process using fabric script.</p>
:ET
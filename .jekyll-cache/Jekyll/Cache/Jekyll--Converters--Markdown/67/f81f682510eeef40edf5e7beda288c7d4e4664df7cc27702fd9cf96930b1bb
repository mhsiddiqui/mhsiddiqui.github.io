I"ç@<p>Python context managers provides a way to perform some pre processing and post processing related to your cast. This processing can be allocation and releasing of some kind of resources or any other custom task. Context managers are used using Python <code class="highlighter-rouge">with</code> statement. This is in below example.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">something_that_returns_a_context_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">resource</span><span class="p">:</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'done using resource'</span>
</code></pre></div></div>

<p>The most common use of context managers is Resource Management.</p>

<!--more-->

<h2 id="uses-of-context-managers">Uses of Context Managers</h2>

<h3 id="resource-management">Resource Management</h3>

<p>Resource management, in simple word, can be called managing an organizationâ€™s resource in an efficient way when they are needed to increase productivity. In computing, resource management refers to effectively managing resources like RAM, ROM, network sockets, file handlers and power supply etc. We can say that resource management is management of resources and also using them only when they are needed and releasing resources when they have been used.</p>

<p>Every programming language has its own way of managing resources. In Python, this is done using context managers using <code class="highlighter-rouge">with</code> statemente which releases specific resources when execution of specific block of code has been completed. Context manager is actually an object which epitomized or encapsulated these resources. A normal use case of resource management using context manager is a file handling. Normally file handling is done like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="c1"># Read or write content of file here.
</span><span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>The problem in this approach is that when there is some error in processing of file after it has been opened, file will remain open in memory. This problem can be solved by writing code like this.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Read or write content of file here.
</span><span class="k">finally</span><span class="p">:</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>In this way, independent of the result (success/error) of code in <code class="highlighter-rouge">try</code> block, file will be closed in <code class="highlighter-rouge">finally</code> block. This resolve our problem but it require manual release of the resources. Using <code class="highlighter-rouge">with</code> statement, this can be done like this.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="c1"># Read or write content of file here.
</span></code></pre></div></div>
<p><code class="highlighter-rouge">with</code> statement will allocate resources to block of code executing insite <code class="highlighter-rouge">with</code> block and when execution of that block will be complete, it will release all the resources.</p>

<h3 id="other-uses">Other Uses</h3>
<p>There can be other usefull uses of context managers. These can be used anywhere where some pre and post processing is required for your task. An example is the management of Asynchronous tasks where you want to have record of each tasks you are adding in queue and marking its status (success/error). In pre processing of that task, you will add a record of that task in database and in post processing, you will mark its status.</p>

<h2 id="how-context-manager-works">How Context Manager works</h2>
<p>Context managers are very easy to understand. The main components of a context manager a two methods.</p>
<ol>
  <li><code class="highlighter-rouge">__enter__()</code></li>
  <li><code class="highlighter-rouge">__exit__()</code></li>
</ol>

<p>As we know context managers are enabled by <code class="highlighter-rouge">with</code> statement. They works by calling <code class="highlighter-rouge">__enter__()</code> when the <code class="highlighter-rouge">with</code> block is entered. It is like calling <code class="highlighter-rouge">__init__()</code> when object is created. It then binds return value to the target of <code class="highlighter-rouge">as</code>. The <code class="highlighter-rouge">__exit__()</code> function is called when the context is exited. Below it the example of file handling using context managers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="nb">file</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"Exception has been handled"</span>
        <span class="bp">self</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">with</span> <span class="n">File</span><span class="p">(</span><span class="s">'file.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">foo</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="writing-a-custom-context-manager">Writing a custom Context Manager</h2>

<p>We can write custom context manager in Python. There are two different way of doing this.</p>

<ol>
  <li>Context Manager as Class</li>
  <li>Generator as Context Manager</li>
</ol>

<h3 id="context-manager-as-class">Context Manager as Class</h3>

<p>In this way, we will write a class with two methods mentioned above i.e. <code class="highlighter-rouge">__enter__()</code> and <code class="highlighter-rouge">__exit__()</code>. Lets first discuss a scenario for which we want to write a context manager.
We want to read or write a file. But our requirement is such that every file should have some text at start and end of file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FileWithHeadingAndEnd</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">print</span> <span class="s">'Open'</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"foo.txt"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">"File Heading</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fo</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">'File End</span><span class="se">\n</span><span class="s">'</span><span class="p">);</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">'Closed'</span>
</code></pre></div></div>
<p>Print statements are only for understanding code structure. When you will run this code, print statement will tell you code execution order.  Below is the way to use this context manager. When you will run this, you will see file generated have a line at start and end of it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">FileWithHeadingAndEnd</span><span class="p">()</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
   <span class="c1"># Code Block
</span>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Line: </span><span class="si">%</span><span class="s">s </span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

</code></pre></div></div>
<h4 id="how-this-code-works">How this code works?</h4>
<p>These are the steps which python interpreter will perform when it will find a with statement.</p>
<ol>
  <li>Python interpreter will store <code class="highlighter-rouge">FileWithHeadingAndEnd()</code> object in a temporary variable.</li>
  <li><code class="highlighter-rouge">with</code> statement will call <code class="highlighter-rouge">__enter__()</code> method of context manager object</li>
  <li><code class="highlighter-rouge">__enter__()</code> method will create a file, add heading in it and return it to <code class="highlighter-rouge">as</code> path of the context manager.</li>
  <li>Code block under <code class="highlighter-rouge">with</code> statement will be executed.</li>
  <li><code class="highlighter-rouge">with</code> statement will call <code class="highlighter-rouge">__exit__()</code> method of context manager when code block has been executed.</li>
</ol>

<h4 id="what-if-error-occur-during-execution-of-code-block">What if error occur during Execution of code block?</h4>
<p>Suppose an error occurs during execution of code block, following would be the steps taken by python interpreter</p>
<ol>
  <li><code class="highlighter-rouge">with</code> statement will catch error</li>
  <li><code class="highlighter-rouge">with</code> statement will call <code class="highlighter-rouge">__exit__()</code> method of context manager with details of exception.</li>
  <li><code class="highlighter-rouge">__exit__()</code> method will close the file, and return <code class="highlighter-rouge">None</code> (In Python, if function do not have any return statement, it returns <code class="highlighter-rouge">None</code>)</li>
  <li><code class="highlighter-rouge">with</code> statement will check return value and if it is not true, it will re raise exception.</li>
</ol>

<h3 id="generator-as-context-manager">Generator as Context Manager</h3>

<p>In method mentioned above, we created context manager with class having <code class="highlighter-rouge">__enter__()</code> and <code class="highlighter-rouge">__exit__()</code> functions. In this method, we will use generator function as context manager.
This is shown in below example.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="o">@</span><span class="n">contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">make_context</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'  entering'</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"foo2.txt"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"File Heading</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">fo</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">'ERROR:'</span><span class="p">,</span> <span class="n">err</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">'exiting'</span>
    	<span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'File End</span><span class="se">\n</span><span class="s">'</span><span class="p">);</span>
    	<span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>We can use this context manager in similar as above.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">make_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Line: </span><span class="si">%</span><span class="s">s </span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>
<h2 id="conclusion">Conclusion</h2>
<p>Many use cases can be found for context manager. A good thing about context manager is that you have no need to remember to release resources. All the management is done by object itself.</p>
:ET